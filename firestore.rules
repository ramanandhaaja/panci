rules_version = '2';

// Firestore Security Rules for Panci Collaborative Canvas App
//
// These rules define who can read and write data in the Firestore database.
// They enforce security while allowing the collaborative features to work.
//
// To deploy these rules:
// 1. Using Firebase Console:
//    - Go to https://console.firebase.google.com
//    - Select your project
//    - Navigate to Firestore Database > Rules
//    - Copy and paste these rules
//    - Click "Publish"
//
// 2. Using Firebase CLI:
//    - Install: npm install -g firebase-tools
//    - Login: firebase login
//    - Init: firebase init firestore (if not already done)
//    - Deploy: firebase deploy --only firestore:rules
//
// Security Principles:
// - All users must be authenticated (even anonymously)
// - Canvas data is publicly readable for collaboration
// - Only authenticated users can create/modify data
// - Users can only update their own presence information
// - Data validation ensures proper structure

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for common validations

    /// Check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    /// Check if the user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /// Check if user is owner or in team members array for a canvas
    function isOwnerOrTeamMember(canvasId) {
      let canvas = get(/databases/$(database)/documents/canvases/$(canvasId));
      return request.auth.uid == canvas.data.ownerId ||
             request.auth.uid in canvas.data.teamMembers;
    }

    /// Check if user is the canvas owner
    function isCanvasOwner(canvasId) {
      let canvas = get(/databases/$(database)/documents/canvases/$(canvasId));
      return request.auth.uid == canvas.data.ownerId;
    }

    /// Check if user is a guest (by checking their user profile)
    function isGuest() {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return user.data.isGuest == true;
    }

    /// Get user's canvas count
    function getUserCanvasCount() {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return user.data.canvasCount;
    }

    /// Validate canvas document structure
    function isValidCanvas() {
      let data = request.resource.data;
      return data.keys().hasAll(['canvasId', 'ownerId', 'teamMembers', 'isPrivate', 'strokes', 'lastUpdated', 'version'])
        && data.canvasId is string
        && data.ownerId is string
        && data.teamMembers is list
        && data.isPrivate is bool
        && data.strokes is list
        && data.strokes.size() <= 1000  // Enforce max strokes limit
        && data.lastUpdated is string
        && data.version is int
        && data.version >= 0;
    }

    /// Validate stroke structure within canvas
    function isValidStroke(stroke) {
      return stroke.keys().hasAll(['id', 'points', 'colorValue', 'strokeWidth', 'timestamp', 'userId'])
        && stroke.id is string
        && stroke.points is list
        && stroke.points.size() > 0
        && stroke.colorValue is int
        && stroke.strokeWidth is number
        && stroke.strokeWidth > 0
        && stroke.strokeWidth <= 50  // Reasonable max stroke width
        && stroke.timestamp is string
        && stroke.userId is string;
    }

    // Canvas documents - Main drawing data
    // Path: /canvases/{canvasId}
    match /canvases/{canvasId} {

      // Private canvases: only owner and team members can read
      // Public canvases: anyone can read
      allow read: if isAuthenticated() && isOwnerOrTeamMember(canvasId);

      // Only authenticated users can create canvases
      // Guests can only create if canvasCount < 1 (limited to 1 canvas)
      // Must set ownerId to the authenticated user
      allow create: if isAuthenticated()
        && request.resource.data.ownerId == request.auth.uid
        && isValidCanvas()
        && (!isGuest() || getUserCanvasCount() < 1);

      // Only owner and team members can update
      allow update: if isAuthenticated()
        && isOwnerOrTeamMember(canvasId)
        && isValidCanvas();

      // Only owner can delete
      allow delete: if isAuthenticated() && isCanvasOwner(canvasId);

      // Active users subcollection - For user presence (Phase 7)
      // Path: /canvases/{canvasId}/active_users/{userId}
      match /active_users/{userId} {

        // Anyone can read active users to see who's online
        allow read: if true;

        // Users can only create/update their own presence document
        allow create, update: if isOwner(userId)
          && request.resource.data.keys().hasAll(['userId', 'name', 'cursorPosition', 'lastSeen'])
          && request.resource.data.userId == userId;

        // Users can only delete their own presence document
        allow delete: if isOwner(userId);
      }
    }

    // User profiles
    // Path: /users/{userId}
    match /users/{userId} {
      // Any authenticated user can read profiles (for team member info)
      allow read: if isAuthenticated();

      // Users can only create/update their own profile
      // Must include all required fields
      allow create, update: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['userId', 'username', 'email', 'canvasCount', 'isGuest', 'createdAt', 'updatedAt']);

      // Users can only delete their own profile
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // Canvas metadata (for canvas discovery, future feature)
    // Path: /canvas_metadata/{canvasId}
    match /canvas_metadata/{canvasId} {
      // Anyone can read canvas metadata
      allow read: if true;

      // Only authenticated users can create/update metadata
      allow write: if isAuthenticated();
    }

    // Deny all other paths by default
    // This ensures security by explicitly denying access to any
    // collections not defined above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
